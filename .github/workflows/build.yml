name: Build Universal FFmpeg

on:
  push:
    branches:
      - main
      - master
      - develop
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      ffmpeg_version:
        description: 'FFmpeg version/commit (e.g., n7.1 or master)'
        required: false
        default: 'master'
        type: string
      doRelease:
        description: 'Publish as GitHub Release'
        type: boolean
        default: false
        required: false
  schedule:
    - cron: '15 3 * * 0'

jobs:
  build-arch-binaries:
    name: Build FFmpeg for ${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: arm64
            runner: macos-15
          - arch: x86_64
            runner: macos-15-intel
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Homebrew cache
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/Homebrew
            /opt/homebrew/Cellar
            /usr/local/Cellar
          key: ${{ runner.os }}-${{ matrix.arch }}-brew-${{ hashFiles('.github/workflows/build-ffmpeg.yml') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.arch }}-brew-

      - name: Install dependencies
        run: |
          brew update
          brew install \
            pkg-config \
            nasm \
            yasm \
            opus \
            theora \
            libvorbis \
            speex \
            lame \
            fdk-aac \
            twolame \
            opencore-amr \
            libgsm \
            openh264 \
            libvpx \
            aom \
            dav1d \
            freetype \
            fribidi \
            libass \
            srt \
            fontconfig \
            bzip2 \
            xz \
            snappy \
            openjpeg \
            webp \
            zimg \
            openssl@3 \
            rtmpdump

      - name: Clean up Homebrew cache
        run: brew cleanup

      - name: Download FFmpeg source
        run: |
          FFMPEG_VER="${{ inputs.ffmpeg_version || 'master' }}"
          git clone --depth 1 --branch "$FFMPEG_VER" https://git.ffmpeg.org/ffmpeg.git ffmpeg-source
          cd ffmpeg-source
          FFMPEG_VERSION=$(git describe --tags --always)
          echo "FFMPEG_VERSION=$FFMPEG_VERSION" >> $GITHUB_ENV
          echo "FFMPEG_VERSION=$FFMPEG_VERSION" > ../ffmpeg_version.txt

      - name: Build FFmpeg natively for ${{ matrix.arch }}
        run: |
          cd ffmpeg-source
          
          BREW_PREFIX=$(brew --prefix)
          
          # Build comprehensive PKG_CONFIG_PATH
          export PKG_CONFIG_PATH="${BREW_PREFIX}/lib/pkgconfig"
          export PKG_CONFIG_PATH="${PKG_CONFIG_PATH}:${BREW_PREFIX}/opt/openjpeg/lib/pkgconfig"
          export PKG_CONFIG_PATH="${PKG_CONFIG_PATH}:${BREW_PREFIX}/opt/openssl@3/lib/pkgconfig"
          
          export LDFLAGS="-L${BREW_PREFIX}/lib"
          export CPPFLAGS="-I${BREW_PREFIX}/include"
          export CFLAGS="-I${BREW_PREFIX}/include"
          
          # Add library paths for common problematic packages
          for pkg in openjpeg openssl@3 aom libvpx; do
            if [ -d "${BREW_PREFIX}/opt/${pkg}" ]; then
              export PKG_CONFIG_PATH="${PKG_CONFIG_PATH}:${BREW_PREFIX}/opt/${pkg}/lib/pkgconfig"
              export LDFLAGS="${LDFLAGS} -L${BREW_PREFIX}/opt/${pkg}/lib"
              export CPPFLAGS="${CPPFLAGS} -I${BREW_PREFIX}/opt/${pkg}/include"
            fi
          done
          
          echo "ðŸ” PKG_CONFIG_PATH: $PKG_CONFIG_PATH"
          
          ./configure \
            --extra-version=universal-$(date +%Y-%m-%d) \
            --extra-cflags="-fno-stack-check" \
            --cc=/usr/bin/clang \
            --enable-pthreads \
            --enable-runtime-cpudetect \
            --enable-version3 \
            --prefix=$PWD/build \
            --pkg-config-flags="--static" \
            --enable-static \
            --disable-shared \
            --disable-ffplay \
            --disable-debug \
            --disable-doc \
            --enable-avfilter \
            --enable-filters \
            --enable-libopus \
            --enable-libtheora \
            --enable-libvorbis \
            --enable-libspeex \
            --enable-libmp3lame \
            --enable-libfdk-aac \
            --enable-encoder=aac \
            --enable-libtwolame \
            --enable-libopencore-amrnb \
            --enable-libopencore-amrwb \
            --enable-libgsm \
            --enable-libopenh264 \
            --enable-libvpx \
            --enable-libaom \
            --enable-libdav1d \
            --enable-libfreetype \
            --enable-libfribidi \
            --enable-libass \
            --enable-libsrt \
            --enable-fontconfig \
            --enable-bzlib \
            --enable-zlib \
            --enable-lzma \
            --enable-libsnappy \
            --enable-libopenjpeg \
            --enable-libwebp \
            --enable-opengl \
            --enable-opencl \
            --enable-libzimg \
            --enable-openssl \
            --enable-librtmp \
            --enable-muxer=mp4
          
          make -j$(sysctl -n hw.ncpu)
          make install
          
          echo "ðŸ” Built binary architecture:"
          lipo -info build/bin/ffmpeg
          
          echo "ðŸ” Checking dynamic dependencies:"
          otool -L build/bin/ffmpeg | head -20
          
          cp build/bin/ffmpeg ../ffmpeg-${{ matrix.arch }}
          cp build/bin/ffprobe ../ffprobe-${{ matrix.arch }}

      - name: Upload ${{ matrix.arch }} binaries
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-${{ matrix.arch }}
          path: |
            ffmpeg-${{ matrix.arch }}
            ffprobe-${{ matrix.arch }}
            ffmpeg_version.txt
          retention-days: 1

  create-universal-binary:
    name: Create Universal Binary
    needs: build-arch-binaries
    runs-on: macos-15
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download arm64 binaries
        uses: actions/download-artifact@v4
        with:
          name: ffmpeg-arm64
          path: ./arm64

      - name: Download x86_64 binaries
        uses: actions/download-artifact@v4
        with:
          name: ffmpeg-x86_64
          path: ./x86_64

      - name: Read FFmpeg version
        run: |
          FFMPEG_VERSION=$(cat ./arm64/ffmpeg_version.txt)
          echo "FFMPEG_VERSION=$FFMPEG_VERSION" >> $GITHUB_ENV

      - name: Create universal binaries
        run: |
          lipo -create ./arm64/ffmpeg-arm64 ./x86_64/ffmpeg-x86_64 -output ffmpeg
          lipo -create ./arm64/ffprobe-arm64 ./x86_64/ffprobe-x86_64 -output ffprobe
          
          chmod +x ffmpeg ffprobe
          
          echo "ðŸ” Verifying universal binaries..."
          lipo -info ffmpeg
          lipo -info ffprobe
          
          echo ""
          echo "ðŸ” Checking dynamic dependencies:"
          otool -L ffmpeg | head -20
          
          echo ""
          echo "ðŸ“Š Testing ffmpeg..."
          ./ffmpeg -version

      - name: Create archives
        run: |
          mkdir -p ffmpeg-universal-macos
          cp ffmpeg ffmpeg-universal-macos/
          cp ffprobe ffmpeg-universal-macos/
          ./ffmpeg -version > ffmpeg-universal-macos/VERSION.txt
          
          tar -czf ffmpeg-universal-macos.tar.gz ffmpeg-universal-macos/
          zip -r ffmpeg-universal-macos.zip ffmpeg-universal-macos/

      - name: Generate checksums
        run: |
          sha256sum ffmpeg-universal-macos.tar.gz ffmpeg-universal-macos.zip > checksums.sha256
          cat checksums.sha256

      - name: Upload universal binaries
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-universal-macos-${{ env.FFMPEG_VERSION }}
          path: |
            ffmpeg-universal-macos.tar.gz
            ffmpeg-universal-macos.zip
            checksums.sha256
          retention-days: 90

  publish-release:
    name: Publish Release
    if: |
      !cancelled() && 
      needs.create-universal-binary.result == 'success' &&
      (github.event.inputs.doRelease == 'true' || 
       github.event_name == 'schedule' || 
       startsWith(github.ref, 'refs/tags/'))
    needs: create-universal-binary
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: ffmpeg-universal-macos-*
          merge-multiple: true
          path: artifacts

      - name: Create release
        run: |
          set -xe
          RELDATE="$(date +'%Y-%m-%d %H:%M')"
          TAGNAME="autobuild-$(date +'%Y-%m-%d-%H-%M')"
          NAME="FFmpeg Universal macOS - $RELDATE"
          
          gh release create "$TAGNAME" \
            --target "${{ github.ref_name }}" \
            --title "$NAME" \
            --notes "Automated universal macOS build of FFmpeg" \
            artifacts/*.{tar.gz,zip,sha256}
        env:
          GITHUB_TOKEN: ${{ github.token }}

      - name: Update latest release
        if: github.event_name == 'schedule' || github.event.inputs.doRelease == 'true'
        run: |
          set -xe
          RELDATE="$(date +'%Y-%m-%d %H:%M')"
          NAME="Latest FFmpeg Universal macOS ($RELDATE)"
          TAGNAME="latest"
          
          gh release delete --cleanup-tag --yes "$TAGNAME" 2>/dev/null || true
          sleep 5
          
          gh release create "$TAGNAME" \
            --target "${{ github.ref_name }}" \
            --title "$NAME" \
            --notes "Latest automated universal macOS build of FFmpeg" \
            artifacts/*.{tar.gz,zip,sha256}
        env:
          GITHUB_TOKEN: ${{ github.token }}
