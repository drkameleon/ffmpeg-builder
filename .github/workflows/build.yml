name: Build Universal FFmpeg

on:
  push:
    branches:
      - main
      - master
      - develop
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      ffmpeg_version:
        description: 'FFmpeg version/commit (e.g., n7.1 or master)'
        required: false
        default: 'master'
        type: string

jobs:
  build-arch-binaries:
    name: Build FFmpeg for ${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - arch: arm64
            runner: macos-15  # Apple Silicon (Sequoia)
          - arch: x86_64
            runner: macos-15-intel  # Intel (Sequoia)
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Homebrew cache
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/Homebrew
            /opt/homebrew/Cellar
            /usr/local/Cellar
          key: ${{ runner.os }}-${{ matrix.arch }}-brew-${{ hashFiles('.github/workflows/build-ffmpeg.yml') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.arch }}-brew-

      - name: Install dependencies
        run: |
          # Update Homebrew (but don't upgrade already installed packages)
          brew update
          
          # Install packages (will skip if already cached and installed)
          brew install \
            pkg-config \
            nasm \
            yasm \
            opus \
            theora \
            libvorbis \
            speex \
            lame \
            fdk-aac \
            twolame \
            opencore-amr \
            libgsm \
            openh264 \
            libvpx \
            aom \
            dav1d \
            freetype \
            fribidi \
            libass \
            srt \
            fontconfig \
            bzip2 \
            xz \
            snappy \
            openjpeg \
            webp \
            zimg \
            openssl@3 \
            rtmpdump

      - name: Clean up Homebrew cache
        run: |
          # Remove outdated downloads to keep cache size manageable
          brew cleanup

      - name: Debug pkg-config paths
        run: |
          echo "ðŸ” Homebrew prefix: $(brew --prefix)"
          echo "ðŸ” OpenJPEG location: $(brew --prefix openjpeg)"
          echo "ðŸ” Checking for libopenjp2.pc:"
          find $(brew --prefix) -name "libopenjp2.pc" 2>/dev/null || echo "Not found in standard locations"
          echo "ðŸ” PKG_CONFIG_PATH will be set to:"
          echo "$(brew --prefix)/lib/pkgconfig:$(brew --prefix openjpeg)/lib/pkgconfig"

      - name: Download FFmpeg source
        run: |
          FFMPEG_VER="${{ inputs.ffmpeg_version || 'master' }}"
          git clone --depth 1 --branch "$FFMPEG_VER" https://git.ffmpeg.org/ffmpeg.git ffmpeg-source
          cd ffmpeg-source
          FFMPEG_VERSION=$(git describe --tags --always)
          echo "FFMPEG_VERSION=$FFMPEG_VERSION" >> $GITHUB_ENV
          echo "FFMPEG_VERSION=$FFMPEG_VERSION" > ../ffmpeg_version.txt

      - name: Build FFmpeg natively for ${{ matrix.arch }}
        run: |
          cd ffmpeg-source
          
          # Detect Homebrew prefix
          BREW_PREFIX=$(brew --prefix)
          OPENJPEG_PREFIX=$(brew --prefix openjpeg)
          
          # Set up comprehensive paths
          export PKG_CONFIG_PATH="${BREW_PREFIX}/lib/pkgconfig:${OPENJPEG_PREFIX}/lib/pkgconfig"
          export LDFLAGS="-L${BREW_PREFIX}/lib -L${OPENJPEG_PREFIX}/lib"
          export CPPFLAGS="-I${BREW_PREFIX}/include -I${OPENJPEG_PREFIX}/include"
          export CFLAGS="-I${BREW_PREFIX}/include -I${OPENJPEG_PREFIX}/include"
          
          # Verify pkg-config can find openjpeg
          echo "ðŸ§ª Testing pkg-config for libopenjp2:"
          pkg-config --modversion libopenjp2 || echo "âš ï¸  libopenjp2 not found via pkg-config"
          
          ./configure \
            --extra-version=universal-$(date +%Y-%m-%d) \
            --extra-cflags="-fno-stack-check" \
            --cc=/usr/bin/clang \
            --enable-pthreads \
            --enable-runtime-cpudetect \
            --pkg-config-flags="--static" \
            --enable-version3 \
            --prefix=$PWD/build \
            --disable-ffplay \
            --disable-debug \
            --disable-doc \
            --enable-avfilter \
            --enable-filters \
            --enable-libopus \
            --enable-libtheora \
            --enable-libvorbis \
            --enable-libspeex \
            --enable-libmp3lame \
            --enable-libfdk-aac \
            --enable-encoder=aac \
            --enable-libtwolame \
            --enable-libopencore-amrnb \
            --enable-libopencore-amrwb \
            --enable-libgsm \
            --enable-libopenh264 \
            --enable-libvpx \
            --enable-libaom \
            --enable-libdav1d \
            --enable-libfreetype \
            --enable-libfribidi \
            --enable-libass \
            --enable-libsrt \
            --enable-fontconfig \
            --enable-bzlib \
            --enable-zlib \
            --enable-lzma \
            --enable-libsnappy \
            --enable-libopenjpeg \
            --enable-libwebp \
            --enable-opengl \
            --enable-opencl \
            --enable-libzimg \
            --enable-openssl \
            --enable-librtmp \
            --enable-muxer=mp4
          
          make -j$(sysctl -n hw.ncpu)
          make install
          
          # Verify architecture
          echo "ðŸ” Built binary architecture:"
          lipo -info build/bin/ffmpeg
          
          # Copy binaries
          cp build/bin/ffmpeg ../ffmpeg-${{ matrix.arch }}
          cp build/bin/ffprobe ../ffprobe-${{ matrix.arch }}

      - name: Upload ${{ matrix.arch }} binaries
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-${{ matrix.arch }}
          path: |
            ffmpeg-${{ matrix.arch }}
            ffprobe-${{ matrix.arch }}
            ffmpeg_version.txt
          retention-days: 1

  create-universal-binary:
    name: Create Universal Binary
    needs: build-arch-binaries
    runs-on: macos-15
    
    steps:
      - name: Download arm64 binaries
        uses: actions/download-artifact@v4
        with:
          name: ffmpeg-arm64
          path: ./arm64

      - name: Download x86_64 binaries
        uses: actions/download-artifact@v4
        with:
          name: ffmpeg-x86_64
          path: ./x86_64

      - name: Read FFmpeg version
        run: |
          FFMPEG_VERSION=$(cat ./arm64/ffmpeg_version.txt)
          echo "FFMPEG_VERSION=$FFMPEG_VERSION" >> $GITHUB_ENV

      - name: Create universal binaries
        run: |
          lipo -create ./arm64/ffmpeg-arm64 ./x86_64/ffmpeg-x86_64 -output ffmpeg
          lipo -create ./arm64/ffprobe-arm64 ./x86_64/ffprobe-x86_64 -output ffprobe
          
          chmod +x ffmpeg ffprobe
          
          echo "ðŸ” Verifying universal binaries..."
          lipo -info ffmpeg
          lipo -info ffprobe
          
          echo ""
          echo "ðŸ“Š Testing ffmpeg..."
          ./ffmpeg -version

      - name: Create archive
        run: |
          mkdir -p ffmpeg-universal-macos
          cp ffmpeg ffmpeg-universal-macos/
          cp ffprobe ffmpeg-universal-macos/
          
          ./ffmpeg -version > ffmpeg-universal-macos/VERSION.txt
          
          tar -czf ffmpeg-universal-macos.tar.gz ffmpeg-universal-macos/
          zip -r ffmpeg-universal-macos.zip ffmpeg-universal-macos/

      - name: Upload universal binaries
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-universal-macos-${{ env.FFMPEG_VERSION }}-${{ github.sha }}
          path: |
            ffmpeg-universal-macos.tar.gz
            ffmpeg-universal-macos.zip
          retention-days: 90

      - name: Create Release on Tag
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ffmpeg-universal-macos.tar.gz
            ffmpeg-universal-macos.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
